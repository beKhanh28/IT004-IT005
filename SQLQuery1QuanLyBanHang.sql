CREATE DATABASE BAI1_QLBH
USE BAI1_QLBH
CREATE TABLE KHACHHANG (
	MAKH char(4) PRIMARY KEY,
	HOTEN varchar(40),
	DCHI varchar(50),
	SODT varchar(20),
	NGSINH smalldatetime,
	NGDK smalldatetime,
	DOANHSO money,
)

CREATE TABLE NHANVIEN (
	MANV char(4) PRIMARY KEY,
	HOTEN varchar(40),
	SODT varchar(20),
	NGVL smalldatetime,
)

CREATE TABLE SANPHAM (
	MASP char(4) PRIMARY KEY,
	TENSP varchar(40),
	DVT varchar(20),
	NUOCSX varchar(40),
	GIA money,
)

CREATE TABLE HOADON (
	SOHD int,
	NGHD smalldatetime,
	MAKH char(4),
	MANV char(4),
	TRIGIA money,
	PRIMARY KEY (MAKH, MANV)
)

CREATE TABLE CTHD ( 
	SOHD int PRIMARY KEY,
	MASP char(4) ,
	SL int,
)

ALTER TABLE HOADON 
ADD CONSTRAINT FK_HOADON_KHACHHANG FOREIGN KEY(MAKH) REFERENCES KHACHHANG(MAKH)

ALTER TABLE HOADON 
ADD CONSTRAINT FK_HOADON_NHANVIEN FOREIGN KEY(MANV) REFERENCES NHANVIEN(MANV)

ALTER TABLE CTHD 
ADD CONSTRAINT FK_CTHD_SANPHAM FOREIGN KEY(MASP) REFERENCES SANPHAM(MASP)

ALTER TABLE HOADON 
ADD CONSTRAINT FK_HOADON_CTHD FOREIGN KEY(SOHD) REFERENCES CTHD(SOHD)

ALTER TABLE SANPHAM ADD GHICHU varchar(20) 

ALTER TABLE KHACHHANG ADD LOAIKH varchar(40)

ALTER TABLE SANPHAM ALTER COLUMN GHICHU varchar(100)

ALTER TABLE SANPHAM DROP COLUMN GHICHU 

ALTER TABLE KHACHHANG 
ADD CONSTRAINT LOAIKH_CK CHECK(LOAIKH IN ('Vang lai', 'Thuong xuyen', 'Vip'))

ALTER TABLE SANPHAM 
ADD CONSTRAINT DVT_CK CHECK(DVT IN('cay','hop','cai','quyen','chuc'))

ALTER TABLE SANPHAM
ADD CONSTRAINT GIA_CK CHECK (GIA > 500) 

ALTER TABLE CTHD 
ADD CONSTRAINT SL_CK CHECK (SL >= 1) 

ALTER TABLE KHACHHANG
ADD CONSTRAINT NGDK_NGSINH_CK CHECK (NGDK > NGSINH) 

INSERT INTO KHACHHANG (MAKH, HOTEN, DCHI, SODT, NGSINH, NGDK, DOANHSO)
VALUES
('KH01', 'Nguyen Van A', '731 Tran Hung Dao, Q5, TpHCM', '08823451', '1960-10-22', 13060000, '2006-07-22'),
('KH02', 'Tran Ngoc Han', '23/5 Nguyen Trai, Q5, TpHCM', '0908256478', '1974-04-03', 280000, '2006-07-30'),
('KH03', 'Tran Ngoc Linh', '45 Nguyen Canh Chan, Q1, TpHCM', '0938776266', '1980-06-12', 3860000, '2006-08-05'),
('KH04', 'Tran Minh Long', '50/34 Le Dai Hanh, Q10, TpHCM', '0917325476', '1965-03-09', 250000, '2006-10-02'),
('KH05', 'Le Nhat Minh', '34 Truong Dinh, Q3, TpHCM', '08246108', '1950-03-10', 21000, '2006-10-28'),
('KH06', 'Le Hoai Thuong', '227 Nguyen Van Cu, Q5, TpHCM', '08631738', '1981-12-31', 915000, '2006-11-24'),
('KH07', 'Nguyen Van Tam', '32/3 Tran Binh Trong, Q5, TpHCM', '0916783565', '1971-04-06', 12500, '2006-12-01'),
('KH08', 'Phan Thi Thanh', '45/2 An Duong Vuong, Q5, TpHCM', '0938435756', '1971-01-10', 365000, '2006-12-13'),
('KH09', 'Le Ha Vinh', '873 Le Hong Phong, Q5, TpHCM', '08654763', '1979-09-03', 70000, '2007-01-14'),
('KH10', 'Ha Duy Lap', '34/34B Nguyen Trai, Q1, TpHCM', '08768904', '1983-05-02', 67500, '2007-01-16');

INSERT INTO NHANVIEN (MANV, HOTEN, SODT, NGVL)
VALUES 
('NV01', 'Nguyen Nhu Nhut', '0927345678', '2006-04-13'),
('NV02', 'Le Thi Phi Yen', '0987567390', '2006-04-21'),
('NV03', 'Nguyen Van B', '0997047382', '2006-04-27'),
('NV04', 'Ngo Thanh Tuan', '0913758498', '2006-06-24'),
('NV05', 'Nguyen Thi Truc Thanh', '0918590387', '2006-07-20');

INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA)
VALUES
('BC01', 'But chi', 'cay', 'Singapore', 3000),
('BC02', 'But chi', 'cay', 'Singapore', 5000),
('BC03', 'But chi', 'cay', 'Viet Nam', 3500),
('BC04', 'But chi', 'hop', 'Viet Nam', 30000),
('BB01', 'But bi', 'cay', 'Viet Nam', 5000),
('BB02', 'But bi', 'cay', 'Trung Quoc', 7000),
('BB03', 'But bi', 'hop', 'Thai Lan', 100000),
('TV01', 'Tap 100 giay mong', 'quyen', 'Trung Quoc', 2500),
('TV02', 'Tap 200 giay mong', 'quyen', 'Trung Quoc', 4500),
('TV03', 'Tap 100 giay tot', 'quyen', 'Viet Nam', 3000),
('TV04', 'Tap 200 giay tot', 'quyen', 'Viet Nam', 5500),
('TV05', 'Tap 100 trang chuc', 'quyen', 'Viet Nam', 23000),
('TV06', 'Tap 200 trang chuc', 'quyen', 'Viet Nam', 53000),
('TV07', 'Tap 100 trang chuc', 'quyen', 'Trung Quoc', 34000),
('ST01', 'So tay 500 trang', 'quyen', 'Trung Quoc', 40000),
('ST02', 'So tay loai 1', 'quyen', 'Viet Nam', 55000),
('ST03', 'So tay loai 2', 'quyen', 'Viet Nam', 51000),
('ST04', 'So tay', 'quyen', 'Thai Lan', 55000),
('ST05', 'So tay mong', 'quyen', 'Thai Lan', 20000),
('ST06', 'Phan viet bang', 'hop', 'Viet Nam', 5000),
('ST07', 'Phan khong bui', 'hop', 'Viet Nam', 7000),
('ST08', 'Bong bang', 'cai', 'Viet Nam', 1000),
('ST09', 'But long', 'cay', 'Viet Nam', 5000),
('ST10', 'But long', 'cay', 'Trung Quoc', 7000);

INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA)
VALUES
(1001, '2006-07-23', 'KH01', 'NV01', 320000),
(1002, '2006-08-12', 'KH01', 'NV02', 840000),
(1003, '2006-08-23', 'KH02', 'NV01', 100000),
(1004, '2006-09-01', 'KH02', 'NV01', 180000),
(1005, '2006-10-20', 'KH01', 'NV02', 3800000),
(1006, '2006-10-16', 'KH01', 'NV03', 2430000),
(1007, '2006-10-28', 'KH03', 'NV03', 510000),
(1008, '2006-10-28', 'KH01', 'NV03', 440000),
(1009, '2006-10-28', 'KH03', 'NV04', 200000),
(1010, '2006-11-01', 'KH01', 'NV01', 5200000),
(1011, '2006-11-04', 'KH04', 'NV03', 250000),
(1012, '2006-11-30', 'KH05', 'NV03', 21000),
(1013, '2006-12-12', 'KH06', 'NV01', 5000),
(1014, '2006-12-31', 'KH03', 'NV02', 3150000),
(1015, '2007-01-01', 'KH06', 'NV01', 910000),
(1016, '2007-01-01', 'KH07', 'NV02', 12500),
(1017, '2007-01-02', 'KH08', 'NV03', 35000),
(1018, '2007-01-13', 'KH08', 'NV03', 330000),
(1019, '2007-01-13', 'KH01', 'NV03', 30000),
(1020, '2007-01-14', 'KH09', 'NV04', 70000),
(1021, '2007-01-16', 'KH10', 'NV03', 67500),
(1022, '2007-01-16', NULL,   'NV03', 7000),
(1023, '2007-01-17', NULL,   'NV01', 330000);

INSERT INTO CTHD (SOHD, MASP, SL)
VALUES
(1001,'TV02',10),
(1001,'ST01',5),
(1001,'BC01',5),
(1001,'BC02',10),
(1001,'ST08',10),
(1002,'BC04',20),
(1002,'BB01',20),
(1002,'BB02',20),
(1003,'BB03',10),
(1004,'TV01',20),
(1004,'TV02',10),
(1004,'TV03',10),
(1004,'TV04',10),
(1005,'TV05',50),
(1005,'TV06',50),
(1006,'TV07',20),
(1006,'ST01',30),
(1006,'ST02',10),
(1007,'ST03',10),
(1008,'ST04',8),
(1009,'ST05',10),
(1010,'TV07',50),
(1010,'ST07',50),
(1010,'ST08',100),
(1010,'ST04',50),
(1010,'TV03',100),
(1011,'ST06',50),
(1012,'ST07',3),
(1013,'ST08',5),
(1014,'BC02',80),
(1014,'BB02',100),
(1014,'BC04',60),
(1014,'BB01',50),
(1015,'BB02',30),
(1015,'BB03',7),
(1016,'TV01',5),
(1017,'TV02',1),
(1017,'TV03',1),
(1017,'TV04',5),
(1018,'ST04',6),
(1019,'ST05',1),
(1019,'ST06',2),
(1020,'ST07',10),
(1021,'ST08',5),
(1021,'TV01',7),
(1021,'TV02',10),
(1022,'ST07',1),
(1023,'ST04',6);

SELECT * INTO SANPHAM1 FROM SANPHAM 
SELECT * INTO KHACHHANG1 FROM KHACHHANG

UPDATE SANPHAM1 SET GIA = GIA * 1.05 
WHERE NUOCSX = 'Thai Lan' 

UPDATE SANPHAM1 SET GIA = GIA * 0.95
WHERE NUOCSX = 'Trung Quoc' AND GIA < 10000

ALTER TABLE KHACHHANG1
ALTER COLUMN LOAIKH NVARCHAR(20) NULL;

UPDATE KHACHHANG1 SET LOAIKH = 'Vip' 
WHERE (NGDK < '1/1/2007' AND DOANHSO >= 10000000) OR (NGDK > '1/1/2007' AND DOANHSO >= 2000000);

SELECT MASP, TENSP FROM SANPHAM WHERE NUOCSX = 'Trung Quoc'
SELECT MASP, TENSP FROM SANPHAM WHERE DVT = 'cay' OR DVT = 'quyen'
SELECT MASP, TENSP FROM SANPHAM WHERE MASP LIKE 'B%01' 
SELECT MASP, TENSP FROM SANPHAM WHERE NUOCSX = 'Trung Quoc' AND GIA >= 30000 AND GIA <= 40000
SELECT MASP, TENSP FROM SANPHAM WHERE (NUOCSX = 'Trung Quoc' OR NUOCSX = 'Thai Lan') AND GIA >= 30000 AND GIA <= 40000

SELECT SOHD, TRIGIA FROM HOADON WHERE NGHD IN ('1/1/2007','2/1/2007')

SELECT SOHD, TRIGIA FROM HOADON WHERE MONTH(NGHD) = 1 AND YEAR(NGHD)=2007
ORDER BY NGHD ASC, TRIGIA DESC;

SELECT DISTINCT K.MAKH, K.HOTEN FROM KHACHHANG K 
JOIN HOADON H ON K.MAKH = H.MAKH
WHERE H.NGHD = '1/1/2007' 

SELECT DISTINCT H.SOHD, H.TRIGIA FROM HOADON H
JOIN KHACHHANG K ON H.MAKH = K.MAKH
WHERE K.HOTEN = 'Nguyen Van B' AND H.NGHD = ' 28/10/2006'

SELECT DISTINCT S.MASP, S.TENSP FROM SANPHAM S
JOIN CTHD C ON S.MASP = C.MASP
SELECT DISTINCT C.MASP FROM CTHD C
JOIN HOADON H ON C.SOHD = H.SOHD
SELECT DISTINCT H.MAKH FROM HOADON H
JOIN KHACHHANG K ON H.MAKH = H.MAKH 
WHERE K.HOTEN = 'Nguyen Van A' AND MONTH(NGHD) = 10 AND YEAR(NGHD) = 2006

SELECT DISTINCT SOHD FROM CTHD
WHERE MASP IN ('BB01','BB02');

SELECT SOHD FROM CTHD 
WHERE MASP IN('BB01','BB02') AND (SL <= 20 AND SL >= 10)

SELECT SOHD FROM CTHD 
WHERE MASP  = 'BB01' AND SL BETWEEN 10 AND 20
INTERSECT 
SELECT SOHD FROM CTHD 
WHERE MASP  = 'BB02' AND SL BETWEEN 10 AND 20

SELECT DISTINCT MASP, TENSP FROM SANPHAM, HOADON, CTHD 
WHERE HOADON.SOHD = CTHD.SOHD 
AND CTHD.MASP = SANPHAM.MASP
AND (NUOCSX = 'Trung Quoc' OR NGHD = '1/1/2007')

--THUC HANH 25/11 TREN LOP--
SELECT COUNT(*)
FROM HOADON 
WHERE MAKH IS NULL

SELECT COUNT(DISTINCT MASP)
FROM HOADON, CTHD
WHERE HOADON.SOHD = CTHD.SOHD AND YEAR(NGHD) = 2006 

SELECT MAX(TRIGIA), MIN(TRIGIA)
FROM HOADON

SELECT AVG(TRIGIA)
FROM HOADON 
WHERE YEAR(NGHD) = 2006

SELECT SUM(TRIGIA)
FROM HOADON
WHERE YEAR(NGHD) = 2006

SELECT DISTINCT HOTEN 
FROM HOADON, KHACHHANG
WHERE HOADON.MAKH = KHACHHANG.MAKH
AND YEAR(NGHD) = 2006
AND TRIGIA = (SELECT MAX(TRIGIA) FROM HOADON WHERE YEAR(NGHD) = 2006)

SELECT TOP 3 MAKH, HOTEN
FROM KHACHHANG 
ORDER BY DOANHSO DESC --giamdan--

SELECT MASP, TENSP 
FROM SANPHAM 
WHERE GIA IN(
	SELECT DISTINCT TOP 3 GIA 
	FROM SANPHAM 
	ORDER BY GIA DESC )

SELECT MASP, TENSP
FROM SANPHAM
WHERE NUOCSX = 'Thai Lan' AND GIA IN( 
	SELECT DISTINCT TOP 3 GIA 
	FROM SANPHAM 
	ORDER BY GIA DESC )

SELECT MASP, TENSP 
FROM SANPHAM 
WHERE NUOCSX = 'Trung Quoc' AND GIA IN( 
	SELECT DISTINCT TOP 3 GIA 
	FROM SANPHAM 
	WHERE NUOCSX = 'Trung Quoc' --Cua san pham do TQ sx -> co where nuocsx trong day
	ORDER BY GIA DESC )

SELECT TOP 3*
FROM KHACHHANG
ORDER BY DOANHSO DESC

SELECT COUNT(*) 
FROM SANPHAM 
WHERE NUOCSX = 'Trung Quoc' 

SELECT NUOCSX, COUNT(*) SOSP
FROM SANPHAM
GROUP BY NUOCSX

SELECT NUOCSX, MAX(GIA) GIACAONHAT, MIN(GIA) GIATHAPNHAT, AVG(GIA) GIATRUNGBINH
FROM SANPHAM 
GROUP BY NUOCSX 

SELECT NGHD, SUM(TRIGIA) DOANHTHU 
FROM HOADON
GROUP BY NGHD

SELECT SANPHAM.MASP, SUM(SL) SOLUONG
FROM SANPHAM, HOADON, CTHD
WHERE SANPHAM.MASP = CTHD.MASP
	AND CTHD.SOHD = HOADON.SOHD
	AND MONTH(NGHD) = 10 AND YEAR(NGHD) = 2006
GROUP BY SANPHAM.MASP

SELECT MONTH(NGHD) THANG, SUM(TRIGIA) DOANHTHU
FROM HOADON 
WHERE YEAR(NGHD) = 2006 
GROUP BY MONTH(NGHD)

SELECT SOHD 
FROM CTHD
GROUP BY SOHD
HAVING COUNT (DISTINCT MASP) >= 4

SELECT SOHD
FROM SANPHAM, CTHD
WHERE SANPHAM.MASP = CTHD.MASP 
	AND NUOCSX = 'Viet Nam'
GROUP BY SOHD
HAVING COUNT (DISTINCT CTHD.MASP) >=3 

SELECT KHACHHANG.MAKH, HOTEN 
FROM KHACHHANG, HOADON
WHERE KHACHHANG.MAKH = HOADON.MAKH
GROUP BY KHACHHANG.MAKH, HOTEN 
HAVING COUNT(*) >= ALL (
	SELECT COUNT(*) 
	FROM HOADON 
	GROUP BY MAKH )

SELECT MONTH(NGHD) THANG
FROM HOADON 
WHERE YEAR(NGHD) = 2006
HAVING SUM(TRIGIA) >= ALL (
	SELECT SUM(TRIGIA) 
	FROM HOADON
	WHERE YEAR(NGHD) = 2006
	GROUP BY MONTH(NGHD)
	)

SELECT TOP 1 WITH TIES SanPham.MaSP, TenSP 
FROM SANPHAM, CTHD, HOADON
WHERE SANPHAM.MASP = CTHD.MASP 
	AND HOADON.SOHD = CTHD.SOHD 
	AND YEAR (NGHD) = 2006 
GROUP BY SANPHAM.MASP, TENSP 
ORDER BY SUM (SL)

SELECT NUOCSX, MASP, TENSP
FROM SANPHAM SP
WHERE 
	EXISTS ( 
		SELECT NUOCSX
		FROM SANPHAM SP2
		GROUP BY NUOCSX
		HAVING SP.NUOCSX = SP2.NUOCSX
		AND SP.GIA = MAX(GIA)
		)

SELECT NUOCSX
FROM SANPHAM
GROUP BY NUOCSX
HAVING COUNT (DISTINCT GIA) >=3 
